<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>B-Frame</title>
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="/b-frame/manifest.webmanifest" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='24' fill='%230f172a'/%3E%3Cpath d='M28 32h56a12 12 0 0 1 12 12v40a12 12 0 0 1-12 12H28V32z' fill='%231e293b'/%3E%3Crect x='40' y='44' width='64' height='40' rx='6' fill='%23fff' opacity='.06'/%3E%3Cpath d='M44 76l14-18 10 12 8-10 14 16H44z' fill='%2360a5fa'/%3E%3Ctext x='30' y='108' font-family='monospace' font-size='20' fill='%23e2e8f0'%3EB-F%3C/text%3E%3C/svg%3E" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="B-Frame" />
  <base href="/b-frame/">
  <style>
    :root{ --bg:#0b1220; --ui:#0f172a; --text:#e2e8f0; --muted:#94a3b8; --hi:#60a5fa;}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .app{display:flex;flex-direction:column;min-height:100dvh}
    .stage{position:relative;display:flex;justify-content:center;align-items:center;background:#000;min-height:40dvh;max-height:70dvh;touch-action:none;overflow:hidden}
    video{width:100%;height:auto;max-height:70dvh;background:#000;touch-action:none;will-change:transform}
    .time{position:absolute;left:.6rem;bottom:.6rem;background:rgba(0,0,0,.45);border:1px solid rgba(148,163,184,.35);border-radius:.5rem;padding:.2rem .5rem;font-family:ui-monospace,monospace}
    .controls{position:sticky;bottom:0;display:grid;gap:.6rem;padding:.6rem;background:linear-gradient(180deg,rgba(15,23,42,.9),#0f172a);backdrop-filter:saturate(1.2) blur(6px)}
    .row{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center}
    button,.slider{appearance:none;border:none;border-radius:.7rem;background:#1e293b;color:#e2e8f0;padding:.7rem 1rem;font-size:1rem}
    button:active{background:#334155}
    .slider{width:220px;height:38px;padding:.2rem .6rem;display:flex;align-items:center;gap:.4rem}
    .slider input{width:100%}
    .wide{min-width:3.2rem}
    .version{opacity:.6;text-align:center;font-size:.8rem;padding:.4rem 0}
    a.help{color:var(--muted);text-decoration:none;border-bottom:1px dotted var(--muted)}
  </style>
</head>
<body>
<div class="app">
  <div class="stage" id="stage">
    <video id="v" playsinline crossorigin="anonymous"></video>
    <div class="time" id="tc">00:00:00.000</div>
  </div>
  <div class="controls">
    <div class="row">
      <button id="btnFile" class="wide" title="OtevÅ™Ã­t video">ğŸ“‚</button>
      <button id="btnUrl" class="wide" title="OtevÅ™Ã­t URL">ğŸ”—</button>
      <button id="btnSnap" class="wide" title="UloÅ¾it snÃ­mek">ğŸ“¸</button>
    </div>
    <div class="row">
      <button id="btnPrev" class="wide" title="PÅ™edchozÃ­ snÃ­mek">Â«1</button>
      <button id="btnPlay" class="wide" title="PÅ™ehrÃ¡t/Pauza">â–¶ï¸/â¸ï¸</button>
      <button id="btnNext" class="wide" title="DalÅ¡Ã­ snÃ­mek">1Â»</button>
      <button id="btnZoom" class="wide" title="Reset zoom">ğŸ”„</button>
    </div>
    <div class="row slider">
      <label for="speed" style="color:var(--muted)">Rychlost</label>
      <input id="speed" type="range" min="0.1" max="2" step="0.01" value="1" />
      <span id="speedVal" style="min-width:3.5rem;text-align:right">1Ã—</span>
    </div>
 <input id="file" type="file" accept="video/*" hidden />

<script>
  // --- PWA bootstrapping ---
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/b-frame/sw.js');
    });
  }

  // --- App code ---
(function(){
  const v = document.getElementById('v');
  const tc = document.getElementById('tc');
  const f  = document.getElementById('file');
  const q  = id => document.getElementById(id);
  const btnFile=q('btnFile'), btnUrl=q('btnUrl'), btnSnap=q('btnSnap');
  const btnPrev=q('btnPrev'), btnPlay=q('btnPlay'), btnNext=q('btnNext'), btnZoom=q('btnZoom');
  const speed=q('speed'), speedVal=q('speedVal');
  const about=q('about');
  let fps = 30, moved=false;

  // Helpers
  const fmtTime = (t) => {
    const h = Math.floor(t/3600);
    const m = Math.floor((t%3600)/60);
    const s = Math.floor(t%60);
    const ms = Math.floor((t%1)*1000);
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${String(ms).padStart(3,'0')}`;
  };
  function step(n){
    v.pause();
    const dt = 1/Math.max(1, fps|0);
    v.currentTime = Math.max(0, (v.currentTime||0) + n*dt);
  }
  function updateTc(){ tc.textContent = fmtTime(v.currentTime||0); }

  // File & URL
  btnFile.addEventListener('click', ()=> f.click());
  f.addEventListener('change', ()=>{
    const file=f.files&&f.files[0];
    if(file){
      v.src = URL.createObjectURL(file);
      v.play().catch(()=>{});
    }
  });
  btnUrl.addEventListener('click', ()=>{
    const u=prompt('VloÅ¾te URL videa (pozor na CORS, pro snÃ­mek musÃ­ server povolit pÅ™Ã­stup):');
    if(!u) return;
    v.src=u;
    v.play().catch(()=>{});
  });

  // Play/Pause + buttons
  v.addEventListener('click', ()=>{ if(moved){ moved=false; return; } v.paused ? v.play() : v.pause(); });
  btnPlay.addEventListener('click', ()=>{ v.paused ? v.play() : v.pause(); });
  btnNext.addEventListener('click', ()=> step(+1));
  btnPrev.addEventListener('click', ()=> step(-1));
  speed.addEventListener('input', ()=>{
    const r=Number(speed.value)||1;
    speedVal.textContent = (Math.round(r*100)/100).toString().replace(/(\.\d*?)0+$/,'$1').replace(/\.$/,'') + 'Ã—';
    try{ v.playbackRate=r; }catch{}
  });

  // Snapshot
  btnSnap.addEventListener('click', ()=>{
    if(!v.videoWidth){ alert('Nejprve naÄti video.'); return; }
    const c=document.createElement('canvas');
    c.width=v.videoWidth; c.height=v.videoHeight;
    const x=c.getContext('2d', {alpha:false});
    try{
      x.drawImage(v,0,0);
      c.toBlob(b=>{
        if(!b){ alert('NepodaÅ™ilo se vytvoÅ™it snÃ­mek.'); return; }
        const a=document.createElement('a');
        a.href=URL.createObjectURL(b);
        a.download=`frame_${Date.now()}.png`;
        a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href),3000);
      }, 'image/png', 0.92);
    }catch(e){
      alert('SnÃ­mek z cizÃ­ho zdroje je zablokovÃ¡n CORS politikou. PouÅ¾ij lokÃ¡lnÃ­ soubor nebo URL se sprÃ¡vnÃ½mi hlaviÄkami.');
    }
  });

  // Pinch/zoom & pan
  const stage = document.getElementById('stage');
  let scale = 1, tx = 0, ty = 0;
  const MIN_SCALE = 1, MAX_SCALE = 8;
  const pointers = new Map();
  let pinchStart = null;

  const applyTransform = ()=>{
    v.style.transformOrigin = '0 0';
    v.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
  };
  const mp = (a,b)=>({x:(a.x+b.x)/2,y:(a.y+b.y)/2});
  const d  = (a,b)=>Math.hypot(a.x-b.x,a.y-b.y);

  stage.addEventListener('pointerdown', (e)=>{
    stage.setPointerCapture(e.pointerId);
    pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});
    if(pointers.size===2){
      const [p1,p2]=[...pointers.values()];
      pinchStart = { dist:d(p1,p2), scale, tx, ty };
    }
  });
  stage.addEventListener('pointermove', (e)=>{
    if(!pointers.has(e.pointerId)) return;
    const prev=pointers.get(e.pointerId);
    const cur={x:e.clientX, y:e.clientY};
    pointers.set(e.pointerId, cur);
    const rect = stage.getBoundingClientRect();

    if(pointers.size===1){
      if(scale>1){
        tx += cur.x - prev.x;
        ty += cur.y - prev.y;
        applyTransform(); moved=true;
      }
    }else if(pointers.size===2){
      const [a,b]=[...pointers.values()];
      const m = mp(a,b);
      const px = m.x - rect.left, py = m.y - rect.top;
      const s0 = pinchStart?.scale || 1;
      const k  = (d(a,b)/(pinchStart?.dist||1));
      let newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, s0*k));
      const ratio = newScale/scale;
      tx = ratio*tx + (1-ratio)*px;
      ty = ratio*ty + (1-ratio)*py;
      scale = newScale;
      applyTransform(); moved=true;
    }
    e.preventDefault();
  }, {passive:false});
  ['pointerup','pointercancel','pointerleave'].forEach(ev=>{
    stage.addEventListener(ev, e=>{ pointers.delete(e.pointerId); if(pointers.size<2) pinchStart=null; });
  });
  // Wheel zoom
  stage.addEventListener('wheel', (e)=>{
    if(!e.ctrlKey) return;
    const rect = stage.getBoundingClientRect();
    const px = e.clientX - rect.left, py = e.clientY - rect.top;
    const factor = Math.exp((-e.deltaY)*0.0015);
    const newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, scale*factor));
    const ratio = newScale/scale;
    tx = ratio*tx + (1-ratio)*px;
    ty = ratio*ty + (1-ratio)*py;
    scale = newScale;
    applyTransform();
    e.preventDefault();
  }, {passive:false});
  // Reset
  btnZoom.addEventListener('click', ()=>{ scale=1; tx=ty=0; applyTransform(); });

  // Keyboard shortcuts
  window.addEventListener('keydown', (e)=>{
    if(e.key===' '){ e.preventDefault(); v.paused? v.play(): v.pause(); }
    else if(e.key==='ArrowRight'){ step(+1); }
    else if(e.key==='ArrowLeft'){ step(-1); }
    else if(e.key==='0' && e.ctrlKey){ scale=1; tx=ty=0; applyTransform(); }
  });

  // Updates
  v.addEventListener('timeupdate', updateTc);
  v.addEventListener('loadedmetadata', ()=>{
    updateTc();
    // Estimate FPS (if rVFC available)
    if('requestVideoFrameCallback' in HTMLVideoElement.prototype){
      let last=null, n=0;
      const sample=(now,meta)=>{
        if(last!=null){
          const dt=meta.mediaTime-last;
          if(dt>0 && dt<1){ const f=1/dt; fps = Math.max(1, Math.min(240, f)); }
        }
        last=meta.mediaTime; if(n++<90) v.requestVideoFrameCallback(sample);
      };
      v.requestVideoFrameCallback(sample);
    }
  });

  about.addEventListener('click', (e)=>{
    e.preventDefault();
    alert('B-Frame: otevÅ™i lokÃ¡lnÃ­ video (ğŸ“‚) nebo URL (ğŸ”—), krokuj snÃ­mky Â«1 / 1Â», mÄ›Åˆ rychlost, pÅ™ibliÅ¾uj dvÄ›ma prsty / Ctrl+koleÄko a uklÃ¡dej snÃ­mky ğŸ“¸.\n\nPozn.: U snÃ­mkovÃ¡nÃ­ z cizÃ­ URL je nutnÃ©, aby server povolil CORS (crossorigin).');
  });
})();
</script>
</body>
</html>
